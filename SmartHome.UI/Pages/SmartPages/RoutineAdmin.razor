@page "/smarthome/{SmartGuid}/admin/routines"
@inherits SmartHomeGuidPage

@inject IRoutineService routineService;
@inject IDialogService dialogService;
@inject ISnackbar snackBar;

<MudDataGrid Items="@routineList" Filterable="false" SortMode="@SortMode.None" Groupable="false">
    <Columns>
        <PropertyColumn Property="@(x => x.Name)" />
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate>
                <MudStack Row>
                    <MudButton @onclick="@(e => OpenroutineEditDialog(context.Item))" Class="mx-5 my-1" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit" Color="Color.Primary">Edit</MudButton>
                    <MudButton @onclick="@(e => Deleteroutine(context.Item.Id))" Class="mx-5 my-1" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error">Delete</MudButton>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>
<MudPaper Class="d-flex d-inline-flex flex-grow-1 justify-center mb-4 mt-2" Style="width: 100%;" Elevation="0">
    <MudSpacer />
    <MudButton @onclick="@(e => OpenroutineEditDialog(null))" Class="mx-5 my-1" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">Add New routine</MudButton>
</MudPaper>

@code {
    //Deleteroutine
    private List<Routine> routineList = [];

    protected override async Task OnInitializedAsync()
    {
        var result = await routineService.GetAllRoutines(new());

        if (result.EnsureSuccess(snackBar))
            routineList = result.Routines;
    }

    private async void OpenroutineEditDialog(Routine _routineToEditOrCreate)
    {
        string title = "Update routine";
        bool IsNewroutine = (_routineToEditOrCreate is null);

        if (IsNewroutine)
        {
            title = "Create routine";
            _routineToEditOrCreate = new Routine();
        }

        var parameters = new DialogParameters();
        parameters.Add("Routine", _routineToEditOrCreate);

        DialogOptions closeOnEscapeKey = new DialogOptions() { CloseOnEscapeKey = true, BackdropClick = false };
        var dialog = await dialogService.ShowAsync<EditRoutineDialog>(title, parameters, closeOnEscapeKey);
        var result = await dialog.Result;

        if (result.Data != "Close" && result.Data != null)
        {
            //Update de routinelist nadat er een routine is bewerkt of toegevoegd
            if (IsNewroutine)
            {
                routineList.Add(result.Data as Routine);    
            }
        }
    }

    private async Task Deleteroutine(Guid routineGuid)
    {
        //Verwijder routine uit de databse met de api
        var result = await routineService.DeleteRoutine(new(routineGuid));
        result.Show(snackBar, "routine is succesfully deleted!", Severity.Success);

        if (result.WasSuccess())
        {   //local delete from ui
            routineList.RemoveAll(d => d.Id == routineGuid);
        }
    }
}